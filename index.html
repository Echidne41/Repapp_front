<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NH Rep Finder (Key Votes)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-md mx-auto p-4 space-y-4">
    <header class="pt-6">
      <h1 class="text-2xl font-semibold">NH Rep Finder</h1>
      <p class="text-sm text-slate-600">Enter your NH address to see your state reps and their key votes.</p>
    </header>

    <!-- No Google scripts; simple form submit -->
    <form id="form" class="flex gap-2" novalidate>
      <input
        id="addr"
        type="search"
        placeholder="123 Main St, Town, NH"
        autocomplete="street-address"
        class="flex-1 px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Go</button>
    </form>

    <!-- Vote legend -->
    <div id="legend" class="text-xs text-slate-600 flex gap-3 flex-wrap mt-1">
      <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span>Yes</span>
      <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>No</span>
      <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span>Absent</span>
      <span class="inline-flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-400"></span>—</span>
    </div>

    <div id="status" class="text-sm text-slate-600"></div>
    <section id="result" class="space-y-3"></section>
  </div>

  <!-- App script -->
  <script>
    const form = document.getElementById('form');
    const addr = document.getElementById('addr');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = addr.value.trim();
      if (!value) { statusEl.textContent = 'Type an address.'; return; }

      resultEl.innerHTML = '';
      statusEl.textContent = 'Looking up…';
      try {
        const q = new URLSearchParams({ address: value });
        const r = await fetch('https://repapp-9lq6.onrender.com/lookup?' + q.toString());
        const data = await r.json();
        if (!r.ok) {
          statusEl.textContent = data.error || 'Lookup failed.';
          return;
        }
        statusEl.textContent =
          `Base district: ${data.base_district || '—'}` +
          (Array.isArray(data.floterials) && data.floterials.length ? ` · Floterials: ${data.floterials.join(', ')}` : '');
        renderReps(data.reps, data.vote_columns);
      } catch {
        statusEl.textContent = 'Error contacting server.';
      }
    });

    // ---------- UI helpers + render ----------
    function partyClass(p){
      const x = (p || '').trim().toUpperCase();
      if (x === 'D' || x === 'DEM' || x === 'DEMOCRAT') return 'bg-blue-100 text-blue-700';
      if (x === 'R' || x === 'GOP' || x === 'REPUBLICAN') return 'bg-red-100 text-red-700';
      // Independents/Undeclared/Libertarian/Other → yellow
      if (['I','IND','INDEPENDENT','U','UNDECLARED','L','LIBERTARIAN','OTH','OTHER','NPA','NP'].includes(x))
        return 'bg-yellow-100 text-yellow-700';
      return 'bg-slate-100 text-slate-700';
    }

    function voteClass(v){
      const up = (v||'').toUpperCase();
      if (up==='Y' || up==='YES') return 'bg-green-50 border-green-200 text-green-800';
      if (up==='N' || up==='NO')  return 'bg-red-50 border-red-200 text-red-800';
      if (up==='A' || up==='EXCUSED' || up==='ABSENT') return 'bg-amber-50 border-amber-200 text-amber-800';
      return 'bg-slate-50 border-slate-200 text-slate-800';
    }
    function fmtKey(k){ return (k||'').replaceAll('_',' ').trim(); }

    function renderReps(reps, voteCols) {
      if (!reps || !reps.length) {
        resultEl.innerHTML = '<p class="text-sm text-slate-600">No reps found.</p>';
        return;
      }
      const cols = Array.isArray(voteCols) ? voteCols : [];
      resultEl.innerHTML = '';
      reps.forEach(rep => {
        const card = document.createElement('article');
        card.className = 'rounded-xl border bg-white p-4 shadow-sm';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between';
        header.innerHTML = `
          <div>
            <div class="font-semibold">${rep.name || 'Representative'}</div>
            <div class="text-xs text-slate-500">${(rep.party||'').toUpperCase()} · ${rep.district || ''}</div>
          </div>
          <span class="px-2 py-0.5 rounded-full text-xs font-medium ${partyClass(rep.party)}">
            ${(rep.party||'').toUpperCase() || '—'}
          </span>
        `;
        card.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'mt-3 grid grid-cols-2 md:grid-cols-3 gap-2';
        cols.forEach(vk => {
          const val = (rep.votes?.[vk] || '').trim();
          const row = document.createElement('div');
          row.className = `flex items-center justify-between rounded-lg border px-2 py-1 text-sm ${voteClass(val)}`;
          row.innerHTML = `<span class="font-medium">${fmtKey(vk)}</span><span>${val || '—'}</span>`;
          grid.appendChild(row);
        });
        card.appendChild(grid);

        resultEl.appendChild(card);
      });
    }
  </script>
</body>
</html>
