<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>NH Rep Finder (Key Votes)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Make sure the Google dropdown isn't hidden behind stuff */
    .pac-container { z-index: 9999 !important; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-md mx-auto p-4 space-y-4">
    <header class="pt-6">
      <h1 class="text-2xl font-semibold">NH Rep Finder</h1>
      <p class="text-sm text-slate-600">Enter your NH address to see your state reps and their key votes.</p>
    </header>

    <form id="form" class="flex gap-2" novalidate>
      <input
        id="addr"
        type="search"
        placeholder="123 Main St, Town"
        autocomplete="street-address"
        class="flex-1 px-3 py-2 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <button type="submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white">Go</button>
    </form>

    <div id="status" class="text-sm text-slate-600"></div>
    <section id="result" class="space-y-3"></section>
  </div>

  <!-- Main app script -->
  <script>
    const form = document.getElementById('form');
    const addr = document.getElementById('addr');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    // Block accidental submits while typing (Enter in the field)
    addr.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') e.preventDefault();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = addr.value.trim();
      if (!value) { statusEl.textContent = 'Type an address.'; return; }

      resultEl.innerHTML = '';
      statusEl.textContent = 'Looking up…';
      try {
        const q = new URLSearchParams({ address: value });
        const r = await fetch('https://repapp-9lq6.onrender.com/lookup?' + q.toString());
        const data = await r.json();
        if (!r.ok) {
          statusEl.textContent = data.error || 'Lookup failed.';
          return;
        }
        statusEl.textContent =
          `Base district: ${data.base_district || '—'}` +
          (data.floterials?.length ? ` · Floterials: ${data.floterials.join(', ')}` : '');
        renderReps(data.reps, data.vote_columns);
      } catch {
        statusEl.textContent = 'Error contacting server.';
      }
    });

    function renderReps(reps, voteCols) {
      if (!reps || !reps.length) {
        resultEl.innerHTML = '<p class="text-sm text-slate-600">No reps found.</p>';
        return;
      }
      reps.forEach(rep => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border bg-white p-4 shadow-sm';

        const header = document.createElement('div');
        header.className = 'flex items-center justify-between';
        header.innerHTML = `<div>
            <div class="font-medium">${rep.name}</div>
            <div class="text-xs text-slate-500">${(rep.party || '').toUpperCase()} · ${rep.district}</div>
          </div>`;
        card.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'mt-3 grid grid-cols-1 gap-2';
        (voteCols || []).forEach(v => {
          const val = (rep.votes?.[v] || '').trim();
          const up = val.toUpperCase();
          const klass = up === 'Y' || up === 'YES' ? 'bg-green-100 text-green-700'
                      : up === 'N' || up === 'NO'  ? 'bg-red-100 text-red-700'
                      : 'bg-slate-100 text-slate-700';
          const row = document.createElement('div');
          row.className = `flex items-center justify-between rounded-lg px-3 py-2 ${klass}`;
          row.innerHTML = `<span class="text-sm font-medium">${v}</span><span class="text-sm">${val || '—'}</span>`;
          grid.appendChild(row);
        });
        card.appendChild(grid);

        resultEl.appendChild(card);
      });
    }

    // Google Places Autocomplete (NH bias), no auto-submit
    function initPlaces() {
      const input = document.getElementById('addr');
      if (!input) return;

      const nhBounds = new google.maps.LatLngBounds(
        { lat: 42.69, lng: -72.60 }, // SW
        { lat: 45.31, lng: -70.70 }  // NE
      );

      const ac = new google.maps.places.Autocomplete(input, {
        fields: ['formatted_address', 'geometry'],
        types: ['address'],
        componentRestrictions: { country: 'us' },
        bounds: nhBounds,
        strictBounds: true
      });

      ac.addListener('place_changed', () => {
        const p = ac.getPlace();
        if (!p?.formatted_address) return;
        // Only accept NH addresses
        if (!/,\s*NH\b/i.test(p.formatted_address)) {
          alert('Pick a New Hampshire address.');
          return;
        }
        input.value = p.formatted_address;
        // No auto-submit; user clicks Go
      });
    }

    // Sanity check hook (optional)
    window.addEventListener('load', () => {
      // console.log('google loaded?', !!window.google, !!(window.google?.maps?.places));
    });
  </script>

  <!-- Load Maps JavaScript API + Places library -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_REAL_KEY&libraries=places&region=US&callback=initPlaces">
  </script>
</body>
</html>
